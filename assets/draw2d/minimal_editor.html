<!DOCTYPE html>
<html>
<head>
    <title>Minimal Draw2D Editor</title>
    <style>
        #canvas {
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div id="canvas">
        <div id="loading-indicator" style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            text-align: center;
            z-index: 1000;
        ">
            Loading Draw2D Canvas...
        </div>
    </div>
    
    <script>
        console.log('[Draw2D] Minimal editor script starting');
        
        try {
            Alert.postMessage('Minimal editor script is running!');
        } catch (error) {
            console.log('[Draw2D] Alert channel not available:', error);
        }
        
        // Load Draw2D library with timeout and error handling
        console.log('[Draw2D] Attempting to load Draw2D library with diagnostics');
        Alert.postMessage('Loading Draw2D library with diagnostics...');
        
        // Set up timeout to detect if library loading hangs
        const libraryTimeout = setTimeout(() => {
            console.error('[Draw2D] Library loading timeout - likely hanging');
            Alert.postMessage('Draw2D library loading timeout - likely hanging');
            
            // Hide loading indicator
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            // Initialize fallback canvas
            initializeFallbackCanvas();
        }, 5000); // 5 second timeout
        
        const script = document.createElement('script');
        script.src = 'draw2d.js';
        
        script.onload = function() {
            console.log('[Draw2D] Library loaded successfully');
            clearTimeout(libraryTimeout);
            Alert.postMessage('Draw2D library loaded successfully!');
            
            // Hide loading indicator
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            // Try to initialize Draw2D canvas
            try {
                console.log('[Draw2D] Attempting to initialize Draw2D canvas...');
                Alert.postMessage('Attempting to initialize Draw2D canvas...');
                
                // The Draw2D library uses a module system, so we need to access it differently
                // Try to access the draw2d variable from the global scope
                let draw2d = null;
                
                // Check if draw2d is available in global scope
                if (typeof window.draw2d !== 'undefined' && window.draw2d !== null) {
                    draw2d = window.draw2d;
                    console.log('[Draw2D] Found window.draw2d');
                    Alert.postMessage('Found window.draw2d');
                } else if (typeof draw2d !== 'undefined' && draw2d !== null) {
                    // Try global scope
                    draw2d = window.draw2d = draw2d;
                    console.log('[Draw2D] Found draw2d in global scope, assigned to window');
                    Alert.postMessage('Found draw2d in global scope, assigned to window');
                } else {
                    // The draw2d variable exists but is null - the library needs time to initialize
                    console.log('[Draw2D] draw2d variable found but is null, waiting for initialization...');
                    Alert.postMessage('draw2d variable found but is null, waiting for initialization...');
                    
                    // Wait for the library to initialize with a retry mechanism
                    let retryCount = 0;
                    const maxRetries = 10;
                    const retryInterval = 100; // 100ms intervals
                    
                    const waitForDraw2d = () => {
                        retryCount++;
                        console.log('[Draw2D] Retry attempt', retryCount, 'of', maxRetries);
                        Alert.postMessage('Retry attempt ' + retryCount + ' of ' + maxRetries);
                        
                        // Try different ways to access the Draw2D API
                        let draw2dAPI = null;
                        
                        // Method 1: Check if draw2d variable is now available
                        if (typeof draw2d !== 'undefined' && draw2d !== null) {
                            draw2dAPI = draw2d;
                            console.log('[Draw2D] Found draw2d variable');
                            Alert.postMessage('Found draw2d variable');
                        }
                        // Method 2: Check if it's available on window
                        else if (typeof window.draw2d !== 'undefined' && window.draw2d !== null) {
                            draw2dAPI = window.draw2d;
                            console.log('[Draw2D] Found window.draw2d');
                            Alert.postMessage('Found window.draw2d');
                        }
                        // Method 3: Try to access it from the global scope
                        else if (typeof window.draw2d !== 'undefined') {
                            draw2dAPI = window.draw2d;
                            console.log('[Draw2D] Found window.draw2d (even if null)');
                            Alert.postMessage('Found window.draw2d (even if null)');
                        }
                        // Method 4: Try to access it from the script's scope
                        else {
                            try {
                                // Try to evaluate the draw2d variable from the global scope
                                const globalDraw2d = eval('draw2d');
                                if (typeof globalDraw2d !== 'undefined' && globalDraw2d !== null) {
                                    draw2dAPI = globalDraw2d;
                                    console.log('[Draw2D] Found draw2d via eval');
                                    Alert.postMessage('Found draw2d via eval');
                                }
                            } catch (error) {
                                console.log('[Draw2D] eval failed:', error);
                            }
                        }
                        
                        // Method 5: Try to force initialization by executing the library's code
                        if (draw2dAPI === null) {
                            try {
                                console.log('[Draw2D] Trying to force Draw2D initialization...');
                                Alert.postMessage('Trying to force Draw2D initialization...');
                                
                                // Try to execute the library's initialization code
                                if (typeof window.draw2d === 'undefined') {
                                    // The library might need to be executed again
                                    console.log('[Draw2D] Attempting to re-execute library...');
                                    Alert.postMessage('Attempting to re-execute library...');
                                    
                                    // Try to access the draw2d variable from the global scope
                                    const script = document.createElement('script');
                                    script.textContent = `
                                        if (typeof draw2d !== 'undefined' && draw2d !== null) {
                                            window.draw2d = draw2d;
                                            console.log('[Draw2D] Successfully exposed draw2d to window');
                                        }
                                    `;
                                    document.head.appendChild(script);
                                    
                                    // Check if it worked
                                    if (typeof window.draw2d !== 'undefined' && window.draw2d !== null) {
                                        draw2dAPI = window.draw2d;
                                        console.log('[Draw2D] Successfully exposed draw2d to window');
                                        Alert.postMessage('Successfully exposed draw2d to window');
                                    }
                                }
                            } catch (error) {
                                console.log('[Draw2D] Force initialization failed:', error);
                            }
                        }
                        
                        if (draw2dAPI !== null) {
                            window.draw2d = draw2dAPI;
                            console.log('[Draw2D] draw2d API found after', retryCount, 'retries');
                            Alert.postMessage('draw2d API found after ' + retryCount + ' retries');
                            
                            // Continue with canvas initialization
                            initializeDraw2dCanvas(draw2dAPI);
                        } else if (retryCount >= maxRetries) {
                            console.error('[Draw2D] draw2d failed to initialize after', maxRetries, 'retries');
                            Alert.postMessage('draw2d failed to initialize after ' + maxRetries + ' retries');
                            initializeFallbackCanvas();
                            return;
                        } else {
                            setTimeout(waitForDraw2d, retryInterval);
                            return;
                        }
                    };
                    
                    waitForDraw2d();
                    return; // Exit early, waitForDraw2d will handle the rest
                }
                
                // Check if draw2d is properly initialized
                if (draw2d === null || typeof draw2d === 'undefined') {
                    console.error('[Draw2D] draw2d is null or undefined after initialization');
                    Alert.postMessage('draw2d is null or undefined after initialization');
                    initializeFallbackCanvas();
                    return;
                }
                
                console.log('[Draw2D] draw2d is available:', Object.keys(draw2d));
                Alert.postMessage('draw2d is available: ' + Object.keys(draw2d).length + ' properties');
                
                // Initialize Draw2D canvas
                initializeDraw2dCanvas(draw2d);
                
            } catch (error) {
                console.error('[Draw2D] Error initializing Draw2D canvas:', error);
                Alert.postMessage('Error initializing Draw2D canvas: ' + error.message);
                initializeFallbackCanvas();
            }
        };
        
        script.onerror = function(error) {
            console.error('[Draw2D] Failed to load library:', error);
            clearTimeout(libraryTimeout);
            Alert.postMessage('Failed to load Draw2D library: ' + error.message);
            
            // Hide loading indicator
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            // Initialize fallback canvas
            initializeFallbackCanvas();
        };
        
        document.head.appendChild(script);
        
        // Fallback canvas function
        function initializeFallbackCanvas() {
            console.log('[Draw2D] Initializing fallback canvas...');
            Alert.postMessage('Initializing fallback canvas...');
            
            try {
                const canvas = document.getElementById('canvas');
                if (canvas) {
                    // Create a simple canvas system
                    const simpleCanvas = {
                        element: canvas,
                        nodes: [],
                        add: function(node) {
                            this.nodes.push(node);
                            this.element.appendChild(node);
                        },
                        remove: function(node) {
                            const index = this.nodes.indexOf(node);
                            if (index > -1) {
                                this.nodes.splice(index, 1);
                                this.element.removeChild(node);
                            }
                        },
                        clear: function() {
                            this.nodes.forEach(node => this.element.removeChild(node));
                            this.nodes = [];
                        }
                    };
                    
                    // Store canvas globally
                    window.draw2dCanvas = simpleCanvas;
                    
                    // Add function to add states
                    window.addStateAtCenter = function() {
                        try {
                            if (window.draw2dCanvas) {
                                console.log('[Draw2D] Adding state to fallback canvas...');
                                
                                // Create a simple circle div element
                                const circle = document.createElement('div');
                                circle.style.position = 'absolute';
                                circle.style.left = '100px';
                                circle.style.top = '100px';
                                circle.style.width = '50px';
                                circle.style.height = '50px';
                                circle.style.backgroundColor = '#4CAF50';
                                circle.style.borderRadius = '50%';
                                circle.style.border = '2px solid #2E7D32';
                                circle.style.cursor = 'pointer';
                                circle.style.zIndex = '10';
                                
                                // Add some text to the circle
                                circle.textContent = 'S' + (window.draw2dCanvas.nodes.length + 1);
                                circle.style.display = 'flex';
                                circle.style.alignItems = 'center';
                                circle.style.justifyContent = 'center';
                                circle.style.color = 'white';
                                circle.style.fontWeight = 'bold';
                                circle.style.fontSize = '12px';
                                
                                // Add to canvas
                                window.draw2dCanvas.add(circle);
                                
                                console.log('[Draw2D] State added to fallback canvas');
                                Alert.postMessage('State added to fallback canvas!');
                                return true;
                            } else {
                                console.error('[Draw2D] Fallback canvas not initialized');
                                Alert.postMessage('Fallback canvas not initialized');
                                return false;
                            }
                        } catch (error) {
                            console.error('[Draw2D] Error adding state to fallback canvas:', error);
                            Alert.postMessage('Error adding state to fallback canvas: ' + error.message);
                            return false;
                        }
                    };
                    
                    // Change canvas background to indicate ready state
                    canvas.style.backgroundColor = '#e8f5e8';
                    canvas.style.border = '2px solid #4caf50';
                    
                    console.log('[Draw2D] Fallback canvas setup complete!');
                    Alert.postMessage('Fallback canvas setup complete!');
                } else {
                    console.error('[Draw2D] Canvas element not found for fallback');
                    Alert.postMessage('Canvas element not found for fallback');
                }
            } catch (error) {
                console.error('[Draw2D] Error initializing fallback canvas:', error);
                Alert.postMessage('Error initializing fallback canvas: ' + error.message);
            }
            }
            
            // Function to initialize Draw2D canvas
            function initializeDraw2dCanvas(draw2d) {
                try {
                    console.log('[Draw2D] Attempting to initialize Draw2D canvas...');
                    Alert.postMessage('Attempting to initialize Draw2D canvas...');
                    
                    // Try to create a Draw2D canvas
                    const canvas = document.getElementById('canvas');
                    if (!canvas) {
                        console.error('[Draw2D] Canvas element not found');
                        Alert.postMessage('Canvas element not found');
                        initializeFallbackCanvas();
                        return;
                    }
                    
                    // Create Draw2D canvas
                    const draw2dCanvas = new draw2d.Canvas('canvas');
                    console.log('[Draw2D] Draw2D canvas created successfully');
                    Alert.postMessage('Draw2D canvas created successfully!');
                    
                    // Store canvas globally
                    window.draw2dCanvas = draw2dCanvas;
                    
                    // Add function to add states
                    window.addStateAtCenter = function() {
                        try {
                            if (window.draw2dCanvas) {
                                console.log('[Draw2D] Adding state to Draw2D canvas...');
                                
                                // Create a Draw2D state
                                const state = new draw2d.shape.basic.Circle();
                                state.setPosition(100, 100);
                                state.setDimension(50, 50);
                                state.setBackgroundColor('#4CAF50');
                                state.setStroke(2);
                                state.setColor('#2E7D32');
                                
                                // Add to canvas
                                window.draw2dCanvas.add(state);
                                
                                console.log('[Draw2D] State added to Draw2D canvas');
                                Alert.postMessage('State added to Draw2D canvas!');
                                return true;
                            } else {
                                console.error('[Draw2D] Draw2D canvas not initialized');
                                Alert.postMessage('Draw2D canvas not initialized');
                                return false;
                            }
                        } catch (error) {
                            console.error('[Draw2D] Error adding state to Draw2D canvas:', error);
                            Alert.postMessage('Error adding state to Draw2D canvas: ' + error.message);
                            return false;
                        }
                    };
                    
                    // Change canvas background to indicate ready state
                    canvas.style.backgroundColor = '#e8f5e8';
                    canvas.style.border = '2px solid #4caf50';
                    
                    console.log('[Draw2D] Draw2D canvas setup complete!');
                    Alert.postMessage('Draw2D canvas setup complete!');
                    
                } catch (error) {
                    console.error('[Draw2D] Error initializing Draw2D canvas:', error);
                    Alert.postMessage('Error initializing Draw2D canvas: ' + error.message);
                    initializeFallbackCanvas();
                }
            }
        </script>
    </body>
</html>
